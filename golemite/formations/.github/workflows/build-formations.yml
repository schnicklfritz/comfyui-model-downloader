---
name: Build Formation Images

on:
  push:
    branches: [main]
    paths:
      - 'formations/**'
      - 'clay/**'
      - '.github/workflows/build-formations.yml'
  workflow_dispatch:
    inputs:
      formation:
        description: 'Formation name to build (leave empty for all)'
        required: false
        type: string

env:
  REGISTRY: docker.io
  BASE_IMAGE: ${{ github.repository_owner }}/golemite-clay
  FORMATIONS_DIR: ./formations

jobs:
  # First job: determine what to build
  prepare:
    runs-on: ubuntu-latest
    outputs:
      formations: ${{ steps.set-formations.outputs.formations }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set formations to build
        id: set-formations
        run: |
          if [ -n "${{ github.event.inputs.formation }}" ]; then
            # Manual trigger with specific formation
            echo "formations=[\"${{ github.event.inputs.formation }}\"]" >> $GITHUB_OUTPUT
          else
            # Build all formations
            echo "formations=[\"tensorart\", \"civitai\", \"huggingface\"]" >> $GITHUB_OUTPUT
          fi

  # Second job: build each formation
  build-formation:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        formation: ${{ fromJson(needs.prepare.outputs.formations) }}
      fail-fast: false
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify formation plugin exists
        run: |
          FORMATION_FILE="${{ env.FORMATIONS_DIR }}/${{ matrix.formation }}.py"
          if [ ! -f "$FORMATION_FILE" ]; then
            echo "❌ Error: $FORMATION_FILE not found"
            exit 1
          else
            echo "✓ Formation file exists: $FORMATION_FILE"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Formation image
        uses: docker/build-push-action@v6
        with:
          context: ./clay
          file: ./clay/Dockerfile.alpine
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          load: ${{ github.event_name == 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/golemite-${{ matrix.formation }}:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/golemite-${{ matrix.formation }}:${{ github.sha }}
          build-args: |
            FORMATION=${{ matrix.formation }}
            BASE_IMAGE=${{ env.BASE_IMAGE }}:latest
          cache-from: |
            type=registry,ref=${{ env.BASE_IMAGE }}:latest
            type=gha
          cache-to: type=gha,mode=max

      - name: Test Formation image
        if: always()
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/golemite-${{ matrix.formation }}:latest"
          echo "Testing image: $IMAGE"
          docker run --rm $IMAGE python3 -c "import sys; print(f'Python {sys.version}')"
