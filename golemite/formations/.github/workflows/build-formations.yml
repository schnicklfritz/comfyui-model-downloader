name: Build Formation Images

on:
  push:
    branches: [ main ]
    paths:
      - 'formations/**'
      - 'clay/**'
      - '.github/workflows/build-formations.yml'
  workflow_dispatch:
    inputs:
      formation:
        description: 'Formation name to build'
        required: true
        default: 'tensorart'

env:
  REGISTRY: docker.io
  BASE_IMAGE: ${{ github.repository_owner }}/golemite-clay
  FORMATIONS_DIR: ./formations

jobs:
  build-formation:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        formation: ${{ fromJson(github.event.inputs.formation != '' && github.event.inputs.formation || '["tensorart", "civitai", "huggingface"]') }}
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Formation image
      uses: docker/build-push-action@v5
      with:
        context: ./clay
        file: ./clay/Dockerfile.alpine
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/golemite-${{ matrix.formation }}:latest
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/golemite-${{ matrix.formation }}:${{ github.sha }}
        build-args: |
          FORMATION=${{ matrix.formation }}
          BASE_IMAGE=${{ env.BASE_IMAGE }}:latest
        cache-from: |
          type=registry,ref=${{ env.BASE_IMAGE }}:latest
          type=gha
        cache-to: type=gha,mode=max

    - name: Verify formation plugin exists
      run: |
        FORMATION_FILE="${{ env.FORMATIONS_DIR }}/${{ matrix.formation }}.py"
        if [ ! -f "$FORMATION_FILE" ]; then
          echo "⚠️ Warning: $FORMATION_FILE not found"
          echo "Creating template formation file..."
          mkdir -p ${{ env.FORMATIONS_DIR }}
          cat > "$FORMATION_FILE" << 'EOF'
          # formations/${{ matrix.formation }}.py
          from .base import BaseFormation
          
          class ${{ matrix.formation | capitalize }}Formation(BaseFormation):
              name = "${{ matrix.formation }}"
              url_patterns = ["${{ matrix.formation }}.com"]
              
              async def execute(self, url, **kwargs):
                  # TODO: Implement ${{ matrix.formation }} download logic
                  return {"status": "not_implemented"}
          
          FORMATION_CLASS = ${{ matrix.formation | capitalize }}Formation
          EOF
        else
          echo "✓ Formation file exists: $FORMATION_FILE"
        fi
